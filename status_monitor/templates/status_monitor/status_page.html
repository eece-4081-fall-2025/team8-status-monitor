{% extends "base.html" %}
{% block title %}Status Dashboard{% endblock %}
{% block content %}

<h2>Dashboard</h2>

{% if user.is_authenticated and user.userprofile.can_configure_sites %}
    <a href="{% url 'site_create' %}" class="btn btn-primary">+ Add Site</a>
{% endif %}
<br><br>

<table class="status-table">
    <tr>
        <th>Name</th>
        <th>URL</th>
        <th>Status</th>
        <th>Actions</th>
    </tr>
    {% for site in sites %}
    <tr class="{% if site.status == 'DOWN' %}row-down{% else %}row-up{% endif %}">
        <td>{{ site.name }}</td>
        <td>{{ site.url }}</td>
        <td>{{ site.status }}</td>
        <td>
            {% if user.is_authenticated and user.userprofile.can_configure_sites %}
                <a href="{% url 'site_edit' site.pk %}">Edit</a> |
                <a href="{% url 'site_delete' site.pk %}">Delete</a>
            {% endif %}
        </td>
    </tr>
    <tr>
        <td colspan="4">
            <div class="status-bars">
                {% for i in site.history %}
                    <span class="status-block {% if i == 'UP' %}green{% else %}red{% endif %}"></span>
                {% endfor %}
            </div>
            <canvas id="responseChart-{{ site.id }}" class="chart"></canvas>
        </td>
    </tr>
    {% endfor %}
</table>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const charts = {};

{% for site in sites %}
const ctx{{ site.id }} = document
    .getElementById("responseChart-{{ site.id }}")
    .getContext("2d");

//define now and 12 hours ago
const now = new Date();
const twelveHoursAgo = new Date(now.getTime()-12*60*60*1000);

//parsing server timestamps into Date object
let timestamps{{ site.id }} = {{ site.timestamps_json|safe }}.map(ts => new Date(ts));
//filter to last 12
timestamps{{ site.id }} = timestamps{{ site.id }}.filter(t => t >= twelveHoursAgo);

//generate labels as local time
let labels{{ site.id }} = timestamps{{ site.id }}.map(t => {
    return t.toLocaleTimeString([], {
         hour:"2-digit",
        minute:"2-digit",
        second:"2-digit",
    })
});
labels{{ site.id }}.unshift(twelveHoursAgo.toLocaleTimeString([], {
        hour:"2-digit",
        minute:"2-digit",
        second:"2-digit"}));
labels{{ site.id }}.push(now.toLocaleTimeString([], {
        hour:"2-digit",
        minute:"2-digit",
        second:"2-digit",}));

let data{{ site.id }} = {{ site.response_times_json|safe }};
data{{ site.id }}.unshift(null);
data{{ site.id }}.push(null);
charts["{{ site.id }}"] = new Chart(ctx{{ site.id }}, {
    type: "line",
    data: {
        labels: labels{{ site.id }},
        datasets: [{
            label: "Response Time",
            data: data{{ site.id }},
            borderColor: "rgb(75, 192, 192)",
            backgroundColor: "rgba(5, 192, 192, 0.2)",
            tension: 0.3,
            fill: true
        }]
    },
    options: {
        animation: { duration: 0 },
        responsive: true,
        scales: {
            x: {
                type: "category",
                title: { display: true, text: "Time" },
                ticks: { maxTicksLimit: 10 }
            },
            y: {
                beginAtZero: true,
                title: { display: true, text: "Response Time" }
            }
        },
        plugins: {
            tooltip: { mode: "index", intersect: false }
        }
    }
});
{% endfor %}
</script>

<script>
setInterval(() => {
    fetch("{% url 'status_page' %}?json=1")
        .then(resp => resp.json())
        .then(data => {
            data.sites.forEach(site => {
                const chart = charts[site.id];
                if (chart) {
                    chart.data.labels = site.timestamps.map(ts => {
                        const date = new Date(ts);
                        return date.toLocaleTimeString([], {
                            hour: "2-digit",
                            minute: "2-digit",
                            second: "2-digit"
                        });
                    });
                    chart.data.datasets[0].data = site.response_times;
                    chart.update("none");
                }
            });
        });
}, 3000);
</script>

{% endblock %}
